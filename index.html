<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Aportaciones</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<style>
body{font-family:Arial;background:#f5fcff;margin:0;padding:25px;color:#023b40}
h1{color:#027b8a;text-align:center;margin-bottom:25px}
.card{display:inline-block;padding:20px;background:white;margin:10px;border-radius:18px;box-shadow:0 4px 10px #0002;min-width:200px}
#charts{display:flex;flex-wrap:wrap;gap:30px;margin-top:20px}
.chartBox{background:white;padding:20px;border-radius:18px;box-shadow:0 4px 10px #0002}
button{padding:12px 22px;background:#02a1b3;color:white;border:none;border-radius:10px;font-size:15px;cursor:pointer}
input,select{padding:10px;border-radius:8px;border:1px solid #ccc;margin:5px 0}
</style>
</head>
<body>
<h1>Dashboard Dinámico de Aportaciones</h1>

<input type="file" id="fileInput" accept=".xlsx,.csv"><br><br>

<div class="card"><h3 id="kpiMonto">Monto Total: $0</h3></div>
<div class="card"><h3 id="kpiPromedio">Promedio: $0</h3></div>
<div class="card"><h3 id="kpiRegistros">Registros: 0</h3></div>

<h3>Filtros</h3>
<select id="fSucursal"></select>
<select id="fPromotor"></select>
<select id="fEstatus"></select>
<select id="fTipo"></select>
<input type="date" id="fIni">
<input type="date" id="fFin">
<button onclick="aplicarFiltros()">Aplicar</button>

<div id="charts">
<div class="chartBox"><canvas id="chartLinea"></canvas></div>
<div class="chartBox"><canvas id="chartDona"></canvas></div>
</div>

<table id="tabla" class="display" style="width:100%;margin-top:30px;"></table>

<script>
let rawData = [];
let filtrado = [];
let tabla;
let chartLinea, chartDona;

document.getElementById('fileInput').addEventListener('change', async e =>{
 const file = e.target.files[0];
 if(!file) return;
 const data = await file.arrayBuffer();
 const workbook = XLSX.read(data);
 const sheet = workbook.SheetNames[0];
 const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheet],{defval:''});
 procesarDatos(json);
});

function procesarDatos(json){
 rawData = json.map(r=>({
   Sucursal: limpiar(r['Sucursal']),
   Promotor: limpiar(r['Promotor']),
   Estatus: limpiar(r['Estatus']),
   Tipo: limpiar(r['Tipo Aportación']),
   Monto: Number(r['Monto']||0),
   FechaApertura: parseFecha(r['Fecha Apertura'])
 }));
 cargarFiltros();
 aplicarFiltros();
}

function limpiar(v){ return (v||'').toString().trim(); }
function parseFecha(v){ return v? new Date(v): null; }

function cargarFiltros(){
 setOpciones('fSucursal', [...new Set(rawData.map(x=>x.Sucursal))]);
 setOpciones('fPromotor', [...new Set(rawData.map(x=>x.Promotor))]);
 setOpciones('fEstatus', [...new Set(rawData.map(x=>x.Estatus))]);
 setOpciones('fTipo', [...new Set(rawData.map(x=>x.Tipo))]);
}

function setOpciones(id, arr){
 const sel = document.getElementById(id);
 sel.innerHTML = '<option value="">Todos</option>' + arr.map(x=>`<option>${x}</option>`).join('');
}

function aplicarFiltros(){
 let suc = fSucursal.value;
 let pro = fPromotor.value;
 let est = fEstatus.value;
 let tip = fTipo.value;
 let ini = fIni.value? new Date(fIni.value):null;
 let fin = fFin.value? new Date(fFin.value):null;

 filtrado = rawData.filter(r=>{
   if(suc && r.Sucursal!==suc) return false;
   if(pro && r.Promotor!==pro) return false;
   if(est && r.Estatus!==est) return false;
   if(tip && r.Tipo!==tip) return false;
   if(ini && (!r.FechaApertura || r.FechaApertura<ini)) return false;
   if(fin && (!r.FechaApertura || r.FechaApertura>fin)) return false;
   return true;
 });
 actualizarKPIs();
 actualizarTabla();
 actualizarGraficas();
}

function actualizarKPIs(){
 let total = filtrado.reduce((a,b)=>a + (b.Monto||0),0);
 let prom = filtrado.length? total/filtrado.length:0;
 kpiMonto.innerText = 'Monto Total: $'+total.toLocaleString();
 kpiPromedio.innerText = 'Promedio: $'+prom.toLocaleString();
 kpiRegistros.innerText = 'Registros: '+filtrado.length;
}

function actualizarTabla(){
 if(tabla) tabla.destroy();
 tabla = $('#tabla').DataTable({
 data: filtrado,
 columns:[
   {title:'Sucursal',data:'Sucursal'},
   {title:'Promotor',data:'Promotor'},
   {title:'Estatus',data:'Estatus'},
   {title:'Tipo',data:'Tipo'},
   {title:'Monto',data:'Monto'},
   {title:'Fecha Apertura',data:'FechaApertura',render:v=>v? v.toLocaleDateString():''}
 ]
 });
}

function actualizarGraficas(){
 const porMes = {};
 filtrado.forEach(r=>{
   if(!r.FechaApertura) return;
   let m = r.FechaApertura.getFullYear()+'-'+(r.FechaApertura.getMonth()+1);
   porMes[m] = (porMes[m]||0) + r.Monto;
 });

 if(chartLinea) chartLinea.destroy();
 chartLinea = new Chart(document.getElementById('chartLinea'),{
   type:'line',
   data:{ labels:Object.keys(porMes), datasets:[{ label:'Monto', data:Object.values(porMes)}] }
 });

 const porEstatus = {};
 filtrado.forEach(r=> porEstatus[r.Estatus]=(porEstatus[r.Estatus]||0)+1);

 if(chartDona) chartDona.destroy();
 chartDona = new Chart(document.getElementById('chartDona'),{
   type:'doughnut',
   data:{ labels:Object.keys(porEstatus), datasets:[{ data:Object.values(porEstatus)}] }
 });
}
</script>
</body>
</html>
