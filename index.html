<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ethernAI — Demo</title>
  <style>
    :root{--bg:#0b0f17;--panel:#0f1720;--accent:#19c2ff;--accent2:#7c3aed;--text:#e6eef6;--muted:#94a3b8;--radius:14px}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:radial-gradient(circle at 10% 10%,#07101a, #08121a 40%,var(--bg));color:var(--text)}
    header{position:sticky;top:0;background:rgba(6,8,12,.64);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.03)}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    .nav{display:flex;align-items:center;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 6px 26px rgba(25,194,255,.12)}
    .tabs{margin-left:auto;display:flex;gap:8px}
    .tab{background:transparent;border:0;padding:8px 12px;color:var(--muted);cursor:pointer;border-radius:10px;font-weight:700}
    .tab.active{color:var(--text);background:linear-gradient(180deg,rgba(25,194,255,.06),rgba(25,194,255,.03))}
    main{padding:20px}
    .panel{display:none;background:linear-gradient(180deg, rgba(255,255,255,.01), rgba(255,255,255,0));border:1px solid rgba(255,255,255,.03); border-radius:var(--radius); padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.45)}
    .panel.active{display:block}

    /* Game layout */
    .game-wrap{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media(max-width:980px){.game-wrap{grid-template-columns:1fr} .tabs{display:none}}
    canvas#game{width:100%;height:480px;border-radius:12px;background:linear-gradient(180deg,#071425,#07101a);display:block}
    .hud{background:linear-gradient(180deg,rgba(124,58,237,.06),rgba(124,58,237,.02));border-radius:12px;padding:12px}
    .stat{display:flex;justify-content:space-between;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,.02);margin-bottom:8px}
    .btn{appearance:none;border:0;padding:10px 12px;border-radius:10px;background:linear-gradient(180deg,var(--accent),var(--accent2));color:#041018;font-weight:800;cursor:pointer}

    /* Registration overlay */
    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
    .card{background:var(--panel);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,.04);min-width:320px}
    .field{display:flex;flex-direction:column;margin-bottom:10px}
    .field input{padding:10px;border-radius:8px;background:#071018;border:1px solid rgba(255,255,255,.03);color:var(--text)}

    /* Data */
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
    .kpi{background:rgba(255,255,255,.02);padding:10px;border-radius:10px;text-align:center}
    table{width:100%;border-collapse:collapse;border-radius:10px;overflow:hidden}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.03);text-align:left}

    /* Catalog */
    .catalog{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .cat{background:linear-gradient(180deg,rgba(25,194,255,.04),rgba(124,58,237,.03));padding:12px;border-radius:12px;cursor:pointer}
    .contact{margin-top:10px;padding:8px;background:rgba(0,0,0,.3);border-radius:8px;border:1px solid rgba(255,255,255,.03)}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand"><div class="logo"></div><div>
        <div style="font-weight:800">ethernAI</div>
        <div style="font-size:12px;color:var(--muted)">Soluciones Industria 4.0 · IA · Big Data</div>
      </div></div>
      <div class="tabs">
        <button class="tab active" data-tab="jugar">Jugar</button>
        <button class="tab" data-tab="datos">Datos</button>
        <button class="tab" data-tab="catalogo">Catálogo</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- JUGAR -->
    <section id="panel-jugar" class="panel active">
      <h1>Juego — El agua huye de la llama</h1>
      <p style="color:var(--muted)">Controla la gota (WASD / flechas) o inclina tu móvil. Recolecta orbes, evita obstáculos y no dejes que la llama te alcance.</p>

      <div class="game-wrap">
        <div style="position:relative">
          <canvas id="game" width="900" height="480"></canvas>

          <div id="overlayReg" class="overlay">
            <div class="card">
              <h2>Registro obligatorio</h2>
              <p class="note" style="color:var(--muted);margin:6px 0">Antes de cada partida registra Nombre, Teléfono y Edad.</p>
              <div class="field"><label>Nombre</label><input id="name" placeholder="Tu nombre" maxlength="40" autocomplete="off"></div>
              <div class="field"><label>Teléfono</label><input id="phone" placeholder="8123836266" maxlength="20" inputmode="tel" autocomplete="off"></div>
              <div class="field"><label>Edad</label><input id="age" type="number" min="5" max="120" autocomplete="off"></div>
              <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
                <button id="btnStart" class="btn">Comenzar</button>
                <button id="btnGyro" class="btn" style="background:linear-gradient(180deg,#fff3 10%,rgba(255,255,255,.02));color:var(--text);font-weight:700">Permitir Giroscopio</button>
              </div>
              <p style="font-size:12px;color:var(--muted);margin-top:8px">Los datos se guardan localmente en tu navegador.</p>
            </div>
          </div>
        </div>

        <aside class="hud">
          <div class="stat"><span>Puntaje</span><strong id="score">0</strong></div>
          <div class="stat"><span>Mejor personal</span><strong id="best">0</strong></div>
          <div class="stat"><span>Sesiones</span><strong id="sessions">0</strong></div>
          <div class="stat"><span>Estado</span><strong id="state">Listo</strong></div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="playBtn" class="btn">▶️ Jugar</button>
            <button id="resetBtn" class="btn">↻ Reiniciar</button>
          </div>
          <p class="note" style="color:var(--muted);margin-top:8px">Tip: en móvil, inclina el teléfono cuando hayas permitido el giroscopio.</p>
        </aside>
      </div>
    </section>

    <!-- DATOS -->
    <section id="panel-datos" class="panel">
      <h1>Dashboard de jugadores</h1>
      <div class="kpis" id="kpis"></div>

      <div style="display:grid;grid-template-columns:1fr 420px;gap:12px;margin-top:12px">
        <div>
          <table>
            <thead><tr><th>Nombre</th><th>Teléfono</th><th>Edad</th><th>Mejor</th><th>Partidas</th><th>Promedio</th><th>Tiempo(s)</th><th>Última</th></tr></thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
        <div style="background:rgba(255,255,255,.02);padding:12px;border-radius:10px">
          <h3 style="margin:0 0 8px">Distribución de edades</h3>
          <canvas id="ageChart" width="380" height="260"></canvas>
          <h3 style="margin-top:12px">Top 5 mejores puntajes</h3>
          <ol id="topList" style="color:var(--muted)"></ol>
        </div>
      </div>
    </section>

    <!-- CATALOGO -->
    <section id="panel-catalogo" class="panel">
      <h1>Catálogo de soluciones</h1>
      <p style="color:var(--muted)">Presiona una tarjeta para ver nuestro contacto.</p>
      <div class="catalog">
        <div class="cat" data-title="Optimización de flujos" onclick="showContact(this)">
          <h3>Optimización de flujos operativos</h3>
          <p style="color:var(--muted)">Mapeo, automatización y reducción de tiempos ciclo.</p>
        </div>
        <div class="cat" data-title="Inventarios" onclick="showContact(this)">
          <h3>Gestión inteligente de inventarios</h3>
          <p style="color:var(--muted)">Forecasting con IA para disminuir faltantes y sobrestock.</p>
        </div>
        <div class="cat" data-title="Mantenimiento" onclick="showContact(this)">
          <h3>Mantenimiento predictivo</h3>
          <p style="color:var(--muted)">Modelos de falla y monitoreo de condición.</p>
        </div>
        <div class="cat" data-title="Analitica" onclick="showContact(this)">
          <h3>Analítica y dashboards</h3>
          <p style="color:var(--muted)">Dashboards accionables y DataOps.</p>
        </div>
        <div class="cat" data-title="Automatizacion" onclick="showContact(this)">
          <h3>Automatización documental</h3>
          <p style="color:var(--muted)">OCR y workflows sin papel.</p>
        </div>
        <div class="cat" data-title="Integracion" onclick="showContact(this)">
          <h3>Integración de datos</h3>
          <p style="color:var(--muted)">Conexión de fuentes y APIs para BI.</p>
        </div>
      </div>
    </section>

  </main>

  <script>
    /* ===== Navegación de pestañas ===== */
    const tabs = document.querySelectorAll('.tab');
    const panels = {jugar:document.getElementById('panel-jugar'), datos:document.getElementById('panel-datos'), catalogo:document.getElementById('panel-catalogo')};
    tabs.forEach(t=>t.addEventListener('click',()=>{ tabs.forEach(b=>b.classList.remove('active')); t.classList.add('active'); Object.values(panels).forEach(p=>p.classList.remove('active')); panels[t.dataset.tab].classList.add('active'); if(t.dataset.tab==='datos') renderDashboard(); }));

    /* ===== Persistencia ===== */
    const LS = 'ethernai_players_v2';
    function load(){ try{return JSON.parse(localStorage.getItem(LS))||[];}catch{return [];} }
    function save(data){ localStorage.setItem(LS, JSON.stringify(data)); }

    /* ====== Juego (canvas) ====== */
    const canvas = document.getElementById('game'); const ctx = canvas.getContext('2d');
    const overlay = document.getElementById('overlayReg');
    const nameIn = document.getElementById('name'); const phoneIn = document.getElementById('phone'); const ageIn = document.getElementById('age');
    const btnStart = document.getElementById('btnStart'); const btnGyro = document.getElementById('btnGyro');
    const playBtn = document.getElementById('playBtn'); const resetBtn = document.getElementById('resetBtn');
    const scoreEl = document.getElementById('score'); const bestEl = document.getElementById('best'); const sessionsEl = document.getElementById('sessions'); const stateEl = document.getElementById('state');

    let players = load(); let current=null; let running=false; let raf=null; let world={w:canvas.width,h:canvas.height};
    let player = {x:120,y:120,r:16,speed:3.6}; let flame = {x:world.w-140,y:world.h-120,r:20,speed:2.8}; let orbs=[]; let obstacles=[];
    let keys={}; let score=0; let best=0; let startTime=0; let sessionCounted=false;

    // Evitar que controles atrapen escritura en inputs
    function isTyping(){ const a = document.activeElement; return a && (a.tagName==='INPUT' || a.tagName==='TEXTAREA'); }

    // controles teclado (ignorar si estás escribiendo)
    window.addEventListener('keydown',e=>{ if(isTyping()) return; if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','KeyW','KeyA','KeyS','KeyD'].includes(e.code)){ keys[e.code]=true; e.preventDefault(); }});
    window.addEventListener('keyup',e=>{ if(isTyping()) return; if(keys[e.code]!==undefined){ keys[e.code]=false; e.preventDefault(); }});

    // giroscopio (movimiento lateral)
    let gyroEnabled=false; let tiltX=0;
    btnGyro.addEventListener('click', async ()=>{
      if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
        try{ const perm = await DeviceMotionEvent.requestPermission(); if(perm==='granted'){ window.addEventListener('deviceorientation', onTilt); gyroEnabled=true; alert('Giroscopio activado'); }}catch(e){alert('Permiso denegado o no soportado'); }
      } else { window.addEventListener('deviceorientation', onTilt); gyroEnabled=true; alert('Giroscopio activado'); }
    });
    function onTilt(e){ tiltX = e.gamma||0; }

    // aparición aleatoria dinámica
    let orbTimer=null, obstacleTimer=null;
    function spawnOrbs(n=6){ orbs.length=0; for(let i=0;i<n;i++){ orbs.push({id:cryptoRandomId(),x:60+Math.random()*(world.w-120),y:60+Math.random()*(world.h-120),r:10,alive:true,ttl: 5000 + Math.random()*8000}); }}
    function spawnObstacles(n=4){ obstacles.length=0; for(let i=0;i<n;i++){ obstacles.push({id:cryptoRandomId(),x:40+Math.random()*(world.w-80),y:40+Math.random()*(world.h-80),w:20,h:20,ttl:8000 + Math.random()*10000}); }}

    function cryptoRandomId(){ return Math.random().toString(36).slice(2,9); }

    function startDynamicSpawns(){ if(orbTimer) clearInterval(orbTimer); if(obstacleTimer) clearInterval(obstacleTimer);
      orbTimer = setInterval(()=>{ // respawn some orbs randomly: remove some, add some
        // randomly toggle an orb
        if(Math.random()<0.5 && orbs.length>0){ const idx=Math.floor(Math.random()*orbs.length); orbs.splice(idx,1); }
        if(Math.random()<0.9) orbs.push({id:cryptoRandomId(),x:60+Math.random()*(world.w-120),y:60+Math.random()*(world.h-120),r:10,alive:true,ttl:4000+Math.random()*9000});
      },3000);
      obstacleTimer = setInterval(()=>{
        if(Math.random()<0.6 && obstacles.length>0){ obstacles.splice(Math.floor(Math.random()*obstacles.length),1); }
        if(Math.random()<0.8) obstacles.push({id:cryptoRandomId(),x:40+Math.random()*(world.w-80),y:40+Math.random()*(world.h-80),w:20,h:20,ttl:6000+Math.random()*10000});
      },4500);
    }

    function stopDynamicSpawns(){ if(orbTimer) clearInterval(orbTimer); if(obstacleTimer) clearInterval(obstacleTimer); orbTimer=null; obstacleTimer=null; }

    function resetWorld(){ player.x=120; player.y=120; flame.x=world.w-140; flame.y=world.h-120; score=0; scoreEl.textContent=0; stateEl.textContent='Listo'; spawnOrbs(); spawnObstacles(); startDynamicSpawns(); best = (current && current.best) ? current.best : 0; bestEl.textContent = best; sessionsEl.textContent = (current && current.sessions) ? current.sessions : (current?0:0); }

    // Para medir tiempos a umbrales durante la sesión
    const thresholds = [10,20,50];
    let thresholdTimes = {};

    btnStart.addEventListener('click', ()=>{
      const name = nameIn.value.trim(); const phone = phoneIn.value.trim(); const age = parseInt(ageIn.value,10);
      if(!name || !phone || !age || age<5 || age>120){ alert('Ingresa nombre, teléfono y edad válidos.'); return; }
      current = {name, phone, age, sessions:0, best:0, totalTime:0, last:new Date().toISOString()};
      // reset threshold trackers
      thresholdTimes = {};
      overlay.style.display='none'; resetWorld(); startGame();
    });

    playBtn.addEventListener('click', ()=>{ if(!current){ overlay.style.display='flex'; return; } if(!running) startGame(); });
    resetBtn.addEventListener('click', ()=>{ endGame(true); overlay.style.display='flex'; current=null; });

    function startGame(){ if(running) return; running=true; stateEl.textContent='Jugando…'; startTime=Date.now(); sessionCounted=true; loop(); }

    function endGame(justReset=false){ running=false; cancelAnimationFrame(raf); raf=null; stateEl.textContent = justReset ? 'Reiniciado' : 'Terminado'; const timeSec = Math.floor((Date.now()-startTime)/1000);
      // guardar datos de la sesión con breakdown de thresholds
      if(current){ current.sessions = (current.sessions||0)+1; current.totalTime = (current.totalTime||0)+timeSec; current.last = new Date().toISOString(); if(score> (current.best||0)){ current.best = score; }
        const sessionRecord = { score, timeSec, thresholds: {...thresholdTimes} };
        // merge into players array
        const idx = players.findIndex(p=>p.name.toLowerCase()===current.name.toLowerCase() && p.phone===current.phone);
        if(idx>=0){ const p = players[idx]; p.sessions = current.sessions; p.totalTime = current.totalTime; p.best = Math.max(p.best||0, current.best); p.records = p.records||[]; p.records.push(sessionRecord); p.last = current.last; }
        else { current.records = [sessionRecord]; players.push(current); }
        save(players);
      }
      stopDynamicSpawns();
      // mostrar popup resumen si no es solo reinicio
      if(!justReset){ alert(`Partida finalizada. Puntaje: ${score} — Tiempo: ${timeSec}s`); }
      // exigir re-registro para jugar otra vez
      overlay.style.display='flex'; current=null;
    }

    function loop(){ update(); draw(); if(running) raf=requestAnimationFrame(loop); }

    function update(){ // movimiento jugador por teclado o gyro
      let dx = (keys.KeyD||keys.ArrowRight ? 1:0) - (keys.KeyA||keys.ArrowLeft ? 1:0);
      let dy = (keys.KeyS||keys.ArrowDown ? 1:0) - (keys.KeyW||keys.ArrowUp ? 1:0);
      if(gyroEnabled){ dx += (tiltX/12); }
      const len = Math.hypot(dx,dy)||1; player.x += (dx/len)*player.speed; player.y += (dy/len)*player.speed;
      player.x = Math.max(player.r, Math.min(world.w-player.r, player.x)); player.y = Math.max(player.r, Math.min(world.h-player.r, player.y));
      // llama persigue
      const fx = player.x - flame.x; const fy = player.y - flame.y; const fl = Math.hypot(fx,fy)||1; flame.x += (fx/fl)*flame.speed; flame.y += (fy/fl)*flame.speed;

      // actualizar TTL orbes y obstáculos
      const now = Date.now();
      orbs.forEach(o=>{ if(o.ttl){ o.ttl -= 16; if(o.ttl<=0) o.alive=false; } });
      obstacles.forEach(ob=>{ if(ob.ttl){ ob.ttl -= 16; } });
      // re-spawn dead orbs occasionally
      if(orbs.filter(o=>o.alive).length < 3 && Math.random()<0.02) orbs.push({id:cryptoRandomId(),x:60+Math.random()*(world.w-120),y:60+Math.random()*(world.h-120),r:10,alive:true,ttl:4000+Math.random()*9000});

      // orbes colision
      for(const o of orbs){ if(!o.alive) continue; const d = Math.hypot(player.x-o.x, player.y-o.y); if(d < player.r + o.r){ o.alive=false; score+=10; scoreEl.textContent=score; // registrar tiempo a umbrales
          const elapsed = Math.floor((Date.now()-startTime)/1000);
          thresholds.forEach(t=>{ if(score>=t && thresholdTimes[t]===undefined) thresholdTimes[t]=elapsed; });
        }}

      // colisiones obstaculos
      for(const ob of obstacles){ if(rectCircleIntersect(player.x,player.y,player.r, ob.x,ob.y,ob.w,ob.h)){ endGame(false); }}
      // colision llama
      if(Math.hypot(player.x-flame.x, player.y-flame.y) < player.r + flame.r){ endGame(false); }
    }

    function draw(){ ctx.clearRect(0,0,world.w,world.h);
      // grid
      ctx.strokeStyle='rgba(25,194,255,0.04)'; ctx.lineWidth=1; for(let x=0;x<world.w;x+=40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,world.h); ctx.stroke(); }
      for(let y=0;y<world.h;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(world.w,y); ctx.stroke(); }

      // orbes (respawned) - draw as glowing circles
      for(const o of orbs){ if(!o.alive) continue; circle(o.x,o.y,o.r,'rgba(25,194,255,0.95)','rgba(0,200,255,0.35)'); }

      // obstacles (rectangles with slight shadow)
      ctx.fillStyle='rgba(180,180,180,0.12)'; for(const ob of obstacles){ ctx.fillRect(ob.x, ob.y, ob.w, ob.h); ctx.strokeStyle='rgba(255,255,255,0.03)'; ctx.strokeRect(ob.x, ob.y, ob.w, ob.h); }

      // jugador (gota) — dibujar forma de lágrima
      drawDrop(player.x, player.y, player.r, '#8be9ff');

      // llama — dibujar con curvas y gradiente
      drawFlame(flame.x, flame.y, flame.r);

      // HUD
      ctx.fillStyle='rgba(229,231,235,0.9)'; ctx.font='bold 16px system-ui'; ctx.fillText('Puntaje: '+score, 14, 24);
    }

    function drawDrop(x,y,r,color){ // lágrima apuntando hacia arriba
      ctx.save(); ctx.translate(x,y);
      // tail
      ctx.beginPath(); ctx.moveTo(0,-r*1.1); ctx.quadraticCurveTo(r*1.2, -r*0.2, 0, r*1.3); ctx.quadraticCurveTo(-r*1.2, -r*0.2, 0, -r*1.1); ctx.closePath();
      const g = ctx.createLinearGradient(0,-r,0,r*1.2); g.addColorStop(0,'#c8fbff'); g.addColorStop(1,color); ctx.fillStyle=g; ctx.fill();
      // highlight
      ctx.beginPath(); ctx.ellipse(-r*0.25, -r*0.35, r*0.25, r*0.45, Math.PI/6, 0, Math.PI*2); ctx.fillStyle='rgba(255,255,255,0.55)'; ctx.fill();
      ctx.restore();
    }

    function drawFlame(x,y,r){ const g = ctx.createRadialGradient(x,y,r*0.2,x,y,r*1.6); g.addColorStop(0,'#fff1c6'); g.addColorStop(0.3,'#ffbe7a'); g.addColorStop(1,'#ff5a2b'); ctx.fillStyle=g; ctx.beginPath(); ctx.moveTo(x, y-r*1.2);
      ctx.bezierCurveTo(x + r*0.9, y - r*0.5, x + r*0.6, y + r*0.8, x, y + r*1.2);
      ctx.bezierCurveTo(x - r*0.6, y + r*0.8, x - r*0.9, y - r*0.5, x, y - r*1.2); ctx.fill();
      // inner flicker
      ctx.beginPath(); ctx.moveTo(x, y-r*0.6); ctx.bezierCurveTo(x + r*0.4, y - r*0.25, x + r*0.25, y + r*0.5, x, y + r*0.8); ctx.bezierCurveTo(x - r*0.25, y + r*0.5, x - r*0.4, y - r*0.25, x, y - r*0.6); ctx.fillStyle='rgba(255,220,140,0.6)'; ctx.fill(); }

    function circle(x,y,r,fill,glow){ const g = ctx.createRadialGradient(x,y,r*0.2,x,y,r*1.8); g.addColorStop(0,glow); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r*1.8,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.fillStyle=fill; ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }

    // catálogo contact
    window.showContact = function(el){ if(el.querySelector('.contact')) return; const d=document.createElement('div'); d.className='contact'; d.innerHTML='Tel: <strong>8123836266</strong><br>Email: <strong>thisis.ethernai@gmail.com</strong>'; el.appendChild(d); }

    // Dashboard
    function renderDashboard(){ const list = load(); const kpis = document.getElementById('kpis'); if(!list.length){ kpis.innerHTML='<div style="grid-column:1/-1;color:var(--muted)">No hay registros aún</div>'; document.getElementById('rows').innerHTML=''; document.getElementById('topList').innerHTML=''; return; }
      // KPIs
      const totalPlayers = list.length;
      const totalSessions = list.reduce((a,p)=>a+(p.records? p.records.length:0),0);
      const bestGlobal = list.reduce((m,p)=>Math.max(m, ...(p.records? p.records.map(r=>r.score):[0])),0);
      const avgScore = (list.reduce((a,p)=>a + (p.records? p.records.reduce((x,y)=>x+y.score,0):0),0) / Math.max(1, totalSessions)).toFixed(1);
      const avgTime = (list.reduce((a,p)=>a + (p.records? p.records.reduce((x,y)=>x+y.timeSec,0):0),0) / Math.max(1, totalSessions)).toFixed(1);
      kpis.innerHTML=`<div class="kpi"><div style="color:var(--muted)">Total jugadores</div><div style="font-weight:800">${totalPlayers}</div></div><div class="kpi"><div style="color:var(--muted)">Partidas totales</div><div style="font-weight:800">${totalSessions}</div></div><div class="kpi"><div style="color:var(--muted)">Mejor global</div><div style="font-weight:800">${bestGlobal}</div></div><div class="kpi"><div style="color:var(--muted)">Puntaje promedio</div><div style="font-weight:800">${avgScore}</div></div>`;
      // tabla
      const tbody = document.getElementById('rows'); tbody.innerHTML=''; list.sort((a,b)=> ( (b.records && b.records.reduce((s,r)=>Math.max(s,r.score),0)) - (a.records && a.records.reduce((s,r)=>Math.max(s,r.score),0)) )); list.forEach(p=>{ const tr=document.createElement('tr'); const scores = p.records? p.records.map(r=>r.score) : []; const avg = scores.length? (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(1) : '—'; const bestp = scores.length? Math.max(...scores) : 0; const totalTime = p.records? p.records.reduce((a,b)=>a+b.timeSec,0) : 0; tr.innerHTML=`<td>${escapeHtml(p.name)}</td><td>${escapeHtml(p.phone)}</td><td>${p.age||'—'}</td><td>${bestp}</td><td>${scores.length}</td><td>${avg}</td><td>${totalTime}</td><td>${p.last? new Date(p.last).toLocaleString() : '—'}</td>`; tbody.appendChild(tr); });

      // edad chart
      const ageCounts = {}; list.forEach(p=>{ if(p.age) ageCounts[p.age]=(ageCounts[p.age]||0)+1; }); const labels = Object.keys(ageCounts); const values = Object.values(ageCounts);
      drawBar('ageChart', labels, values);

      // top list
      const top = [];
      list.forEach(p=>{ if(p.records) p.records.forEach(s=> top.push({name:p.name,score:s.score})); }); top.sort((a,b)=>b.score-a.score); const topList = document.getElementById('topList'); topList.innerHTML=''; top.slice(0,5).forEach(t=>{ const li=document.createElement('li'); li.textContent=`${t.name} — ${t.score}`; topList.appendChild(li); });

      // métricas avanzadas: tiempo promedio, tiempo a X puntos, correlación edad-puntaje
      const timeTo = {10:[],20:[],50:[]};
      list.forEach(p=>{ if(p.records) p.records.forEach(r=>{ [10,20,50].forEach(th=>{ if(r.thresholds && r.thresholds[th]!==undefined) timeTo[th].push(r.thresholds[th]); }); }); });
      function avg(arr){ return arr.length? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : '—'; }
      const advHtml = document.createElement('div'); advHtml.innerHTML = `<div class="kpi"><div style="color:var(--muted)">Tiempo promedio (s)</div><div style="font-weight:800">${avgTime}</div></div><div class="kpi"><div style="color:var(--muted)">Tiempo a 10 pts (s)</div><div style="font-weight:800">${avg(timeTo[10])}</div></div><div class="kpi"><div style="color:var(--muted)">Tiempo a 20 pts (s)</div><div style="font-weight:800">${avg(timeTo[20])}</div></div><div class="kpi"><div style="color:var(--muted)">Tiempo a 50 pts (s)</div><div style="font-weight:800">${avg(timeTo[50])}</div></div>`;
      // append adv metrics below kpis
      kpis.parentNode.insertBefore(advHtml, document.getElementById('rows').parentNode);

      // correlacion edad vs mejor puntaje (Pearson)
      const pairs = [];
      list.forEach(p=>{ if(p.age && p.records){ const bestScore = p.records.reduce((m,r)=>Math.max(m,r.score),0); pairs.push([p.age, bestScore]); }});
      let corr = '—';
      if(pairs.length>=2){ const xs=pairs.map(p=>p[0]); const ys=pairs.map(p=>p[1]); const mean = arr=>arr.reduce((a,b)=>a+b,0)/arr.length; const mx=mean(xs); const my=mean(ys); let num=0, denx=0, deny=0; for(let i=0;i<xs.length;i++){ const dx=xs[i]-mx; const dy=ys[i]-my; num+=dx*dy; denx+=dx*dx; deny+=dy*dy; } corr = (num / Math.sqrt(denx*deny)); corr = isFinite(corr)? corr.toFixed(2) : '—'; }
      const corrDiv = document.createElement('div'); corrDiv.style.marginTop='10px'; corrDiv.innerHTML = `<div style="color:var(--muted)">Correlación edad vs mejor puntaje (Pearson): <strong>${corr}</strong></div>`;
      kpis.parentNode.insertBefore(corrDiv, advHtml.nextSibling);
    }

    function drawBar(id, labels, values){ const c=document.getElementById(id); const x=c.getContext('2d'); x.clearRect(0,0,c.width,c.height); if(labels.length===0){ x.fillStyle='rgba(255,255,255,0.6)'; x.fillText('Sin datos', 10,20); return; } const pad={l:28,r:12,t:8,b:28}; const W=c.width,H=c.height; const max = Math.max(1,...values); const bw = (W-pad.l-pad.r)/values.length - 8; x.fillStyle='rgba(255,255,255,0.9)'; x.font='12px system-ui'; for(let i=0;i<values.length;i++){ const v=values[i]; const h=(v/max)*(H-pad.t-pad.b); const x0=pad.l + i*(bw+8)+4; const y0=H-pad.b-h; const g = x.createLinearGradient(0,y0,0,H-pad.b); g.addColorStop(0,'rgba(25,194,255,0.95)'); g.addColorStop(1,'rgba(25,194,255,0.35)'); x.fillStyle=g; x.fillRect(x0,y0,bw,h); x.fillStyle='rgba(229,231,235,0.9)'; x.textAlign='center'; x.fillText(labels[i], x0+bw/2, H-8); x.fillText(values[i], x0+bw/2, y0-6); } }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[c])); }

    // helper: load and save
    function load(){ try{ return JSON.parse(localStorage.getItem(LS)) || []; }catch{ return []; } }
    // reassign players reference
    players = load();

    // initial
    spawnOrbs(); spawnObstacles(); renderDashboard();

    // simple collision util (rectangle-circle)
    function rectCircleIntersect(cx,cy,cr, rx,ry,rw,rh){ const closestX = Math.max(rx, Math.min(cx, rx+rw)); const closestY = Math.max(ry, Math.min(cy, ry+rh)); const dx = cx-closestX; const dy = cy-closestY; return (dx*dx+dy*dy) < cr*cr; }

    // expose renderDashboard to tabs
    window.renderDashboard = renderDashboard;

    // make canvas responsive
    window.addEventListener('resize', ()=>{ const r = canvas.getBoundingClientRect(); world.w = canvas.width = Math.max(600, Math.floor(r.width)); world.h = canvas.height = 480; });

  </script>
</body>
</html>
