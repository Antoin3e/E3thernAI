<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard de Aportaciones</title>

  <!-- Dependencias → DataTables, Chart.js, jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --acqua: #00bcd4;
      --acqua-dark: #0097a7;
      --bg: #ffffff;
      --muted: #6b7280;
      --card-shadow: 0 6px 18px rgba(3, 60, 77, 0.08);
      --radius: 14px;
      font-family: "Inter", sans-serif;
    }

    html,body{margin:0;background:linear-gradient(180deg,#f0fdff,#ffffff);color:#0f172a}

    /* Layout */
    .app{
      display:grid;
      grid-template-columns:300px 1fr;
      height:100vh;
      gap:20px;
      padding:20px;
    }

    /* Sidebar */
    .sidebar{
      background:white;padding:20px;border-radius:var(--radius);box-shadow:var(--card-shadow);
      overflow-y:auto;
      animation:fadeIn .6s ease;
    }

    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    .logo{background:var(--acqua);color:white;width:50px;height:50px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px;margin-bottom:10px}

    select,input{width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:10px;margin-top:6px}
    .btn{width:100%;padding:10px;border:none;border-radius:10px;background:var(--acqua);color:white;font-weight:700;margin-top:10px;cursor:pointer;transition:.2s}
    .btn:hover{background:var(--acqua-dark)}

    /* Main */
    .card{background:white;padding:18px;border-radius:var(--radius);box-shadow:var(--card-shadow);animation:fadeIn .6s ease}

    .kpis{display:flex;gap:12px}
    .kpi{flex:1;background:#f5feff;padding:16px;border-radius:12px;text-align:center;border:1px solid #e2f9fd}
    .kpi .value{font-size:26px;color:var(--acqua);font-weight:800}

    .charts{display:grid;grid-template-columns:1fr 350px;gap:20px;margin-top:20px}

    table{font-size:13px}

  </style>
</head>
<body>
<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">DA</div>
    <h2 style="margin:0 0 10px 0">Dashboard Aportaciones</h2>
    <p style="color:var(--muted);margin-top:0">Datos cargados automáticamente desde GitHub</p>

    <hr style="margin:15px 0">

    <!-- Filtro de Promotor (principal solicitado) -->
    <label><b>Promotor</b></label>
    <select id="filterPromotor"><option value="">-- Todos --</option></select>

    <label style="margin-top:12px"><b>Sucursal</b></label>
    <select id="filterSucursal"><option value="">-- Todas --</option></select>

    <label style="margin-top:12px"><b>Estatus</b></label>
    <select id="filterEstatus"><option value="">-- Todos --</option></select>

    <label style="margin-top:12px"><b>Tipo Aportación</b></label>
    <select id="filterTipo"><option value="">-- Todos --</option></select>

    <button id="applyFilters" class="btn">Aplicar Filtros</button>
    <button id="resetFilters" class="btn" style="background:#e0fafd;color:var(--acqua-dark)">Reiniciar</button>
  </aside>

  <!-- Main -->
  <main>
    <div class="card">
      <h2 style="margin:0">Resumen</h2>
      <div class="kpis">
        <div class="kpi"><div class="value" id="kpiTotal">$0</div><div>Monto Total</div></div>
        <div class="kpi"><div class="value" id="kpiCount">0</div><div>Registros</div></div>
        <div class="kpi"><div class="value" id="kpiPromedio">$0</div><div>Monto Promedio</div></div>
      </div>
    </div>

    <div class="charts">
      <div class="card"><canvas id="chartMontos"></canvas></div>
      <div class="card"><canvas id="chartEstatus"></canvas></div>
    </div>

    <div class="card">
      <h3>Tabla de Aportaciones</h3>
      <table id="dataTable" style="width:100%">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>
</div>

<script>
// =====================================================
// 1) OBTENER EXCEL DESDE GITHUB DIRECTO
// =====================================================
const GITHUB_URL = "ReporteAportaciones (1).xls"; // pon aquí la URL RAW

let rawData = [];
let filtered = [];
let dataTable = null;
let chartMontos = null;
let chartEstatus = null;

fetch(GITHUB_URL)
  .then(r => r.arrayBuffer())
  .then(buf => {
    const wb = XLSX.read(buf, {type:"array"});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, {defval:""});
    rawData = json;
    initFilters();
    applyFilters();
  })
  .catch(err => alert("ERROR leyendo Excel desde GitHub: " + err));

// =====================================================
// 2) Filtros Dinámicos
// =====================================================
function initFilters(){
  fillSelect("filterPromotor", getUnique("Promotor"));
  fillSelect("filterSucursal", getUnique("Sucursal"));
  fillSelect("filterEstatus", getUnique("Estatus"));
  fillSelect("filterTipo", getUnique("Tipo Aportación"));
}
function getUnique(col){ return [...new Set(rawData.map(r=>r[col]).filter(v=>v))].sort(); }
function fillSelect(id, arr){ document.getElementById(id).innerHTML = '<option value="">-- Todos --</option>' + arr.map(v=>`<option>${v}</option>`).join(''); }

// =====================================================
// 3) Aplicar Filtros
// =====================================================
document.getElementById("applyFilters").onclick = applyFilters;
document.getElementById("resetFilters").onclick = ()=>{
  ["filterPromotor","filterSucursal","filterEstatus","filterTipo"].forEach(id=>document.getElementById(id).value="");
  applyFilters();
};

function applyFilters(){
  const fProm = document.getElementById("filterPromotor").value;
  const fSuc = document.getElementById("filterSucursal").value;
  const fEst = document.getElementById("filterEstatus").value;
  const fTipo = document.getElementById("filterTipo").value;

  filtered = rawData.filter(r=>
     (!fProm || r["Promotor"]===fProm) &&
     (!fSuc || r["Sucursal"]===fSuc) &&
     (!fEst || r["Estatus"]===fEst) &&
     (!fTipo || r["Tipo Aportación"]===fTipo)
  );

  refreshKPIs();
  refreshCharts();
  refreshTable();
}

// =====================================================
// 4) KPIs
// =====================================================
function refreshKPIs(){
  const total = filtered.reduce((a,b)=>a+(Number(b.Monto)||0),0);
  const count = filtered.length;
  const avg = count ? total/count : 0;
  document.getElementById("kpiTotal").innerText = mx(total);
  document.getElementById("kpiCount").innerText = count;
  document.getElementById("kpiPromedio").innerText = mx(avg);
}
function mx(n){ return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(n); }

// =====================================================
// 5) Gráficas
// =====================================================
function refreshCharts(){
  const byMonth = {};
  filtered.forEach(r=>{
    const f = r["Fecha Apertura"] ? String(r["Fecha Apertura"]).slice(0,7) : "Sin fecha";
    byMonth[f] = (byMonth[f]||0) + (Number(r.Monto)||0);
  });

  const labels = Object.keys(byMonth).sort();
  const values = labels.map(k=>byMonth[k]);

  if(chartMontos) chartMontos.destroy();
  chartMontos = new Chart(document.getElementById("chartMontos"),{
    type:"line",
    data:{ labels, datasets:[{ data:values, borderColor:"#00bcd4", backgroundColor:"rgba(0,188,212,.15)", tension:.3 }] },
    options:{ plugins:{legend:{display:false}} }
  });

  const byEst = {};
  filtered.forEach(r=>{ const e=r.Estatus||"Sin Estatus"; byEst[e]=(byEst[e]||0)+1 });
  if(chartEstatus) chartEstatus.destroy();
  chartEstatus = new Chart(document.getElementById("chartEstatus"),{
    type:"doughnut",
    data:{ labels:Object.keys(byEst), datasets:[{ data:Object.values(byEst) }] },
    options:{ plugins:{legend:{position:"bottom"}} }
  });}

// =====================================================
// 6) Tabla
// =====================================================
function refreshTable(){
  const cols = Object.keys(rawData[0]||{});

  if($.fn.DataTable.is
